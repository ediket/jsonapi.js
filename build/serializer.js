

'use strict';

var _ = require('lodash');
var Resource = require('./Resource');
var ResourceCollection = require('./ResourceCollection');

var filterReduceFields = function filterReduceFields(fields, referKey) {

  return _.chain(fields).map(function (field) {
    return field.split('.');
  }).filter(function (props) {
    return props[0] === referKey;
  }).map(function (props) {
    return props.slice(1).join('.');
  }).compact().value();
};

module.exports = {

  serialize: function serialize(resource, options) {

    if (!resource instanceof Resource || !resource instanceof ResourceCollection) {
      throw new TypeError('unsupported type!');
    }

    var result = {
      data: null
    };

    if (resource instanceof ResourceCollection) {

      result = resource.chain().map(function (resource) {
        return serialize(resource, options);
      }).reduce(function (result, serializedResource) {
        result.data.push(serializedResource.data);
        result.included = result.included.concat(serializedResource.included || []);
        return result;
      }, {
        data: [],
        included: []
      }).value();
    } else {

      options = _.defaults(options || {}, {
        include: [],
        fields: {}
      });

      if (!options.fields[resource.type]) {
        options.fields[resource.type] = _.keys(resource.attributes);
      }

      result.data = _.pick(resource.toJSON(), options.fields[resource.type], 'type', 'id');

      result.data.links = _.mapValues(resource.getLinks(), function (resource) {
        return {
          linkage: resource.toLinkage()
        };
      });

      result.included = _.chain(resource.getLinks()).omit(function (resource, key) {
        return !_.contains(options.include, key);
      }).map(function (resource, referKey) {
        return serialize(resource, _.extend({}, options, {
          include: filterReduceFields(options.include, referKey)
        }));
      }).reduce(function (included, serializedResource) {
        return included.concat(included, serializedResource.data, serializedResource.included);
      }, []).value();
    }

    return result;
  },

  deserialize: function deserialize(JSONResponse) {

    if (!(JSONResponse && JSONResponse.data)) {
      return null;
    }

    var included = _.reduce(JSONResponse.included, function (memo, obj) {
      if (!memo[obj.type]) {
        memo[obj.type] = {};
      }
      memo[obj.type][obj.id] = obj;
      return memo;
    }, {});

    var collectResource = (function (_collectResource) {
      function collectResource(_x) {
        return _collectResource.apply(this, arguments);
      }

      collectResource.toString = function () {
        return _collectResource.toString();
      };

      return collectResource;
    })(function (JSONResponse) {

      if (_.isArray(JSONResponse)) {
        return new ResourceCollection(_.map(JSONResponse, function (data) {
          return collectResource(data);
        }));
      }

      var result = new Resource(_.omit(JSONResponse, 'links'));

      if (JSONResponse.links) {
        _.chain(JSONResponse.links).omit(function (link) {
          return !link.linkage;
        }).mapValues(function (link) {

          if (_.isArray(link.linkage)) {
            return collectResource(_.map(link.linkage, function (linkage) {
              return included[linkage.type][linkage.id];
            }));
          } else {
            return collectResource(included[link.linkage.type][link.linkage.id]);
          }
        }).each(function (resource, resourceKey) {
          result.addLink(resourceKey, resource);
        });
      }

      return result;
    });

    return collectResource(JSONResponse.data);
  }

};
//# sourceMappingURL=data:application/json;base64,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LEVBQUUsVUFBVSxPQUFPLEVBQUU7QUFDckMscUJBQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDM0MsQ0FBQyxDQUNILENBQUM7V0FDSCxNQUFNO0FBQ0wsbUJBQU8sZUFBZSxDQUNwQixRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUM3QyxDQUFDO1dBQ0g7U0FFRixDQUFDLENBQ0QsSUFBSSxDQUFDLFVBQVUsUUFBUSxFQUFFLFdBQVcsRUFBRTtBQUNyQyxnQkFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUM7U0FDdkMsQ0FBQyxDQUFDO09BQ047O0FBRUQsYUFBTyxNQUFNLENBQUM7S0FFZixDQUFBLENBQUM7O0FBRUYsV0FBTyxlQUFlLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0dBRTNDOztDQUVGLENBQUMiLCJmaWxlIjoic3JjL3NlcmlhbGl6ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcblxuJ3VzZSBzdHJpY3QnO1xuXG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIFJlc291cmNlID0gcmVxdWlyZSgnLi9SZXNvdXJjZScpO1xudmFyIFJlc291cmNlQ29sbGVjdGlvbiA9IHJlcXVpcmUoJy4vUmVzb3VyY2VDb2xsZWN0aW9uJyk7XG5cblxudmFyIGZpbHRlclJlZHVjZUZpZWxkcyA9IGZ1bmN0aW9uIChmaWVsZHMsIHJlZmVyS2V5KSB7XG5cbiAgcmV0dXJuIF8uY2hhaW4oZmllbGRzKVxuICAgIC5tYXAoZnVuY3Rpb24gKGZpZWxkKSB7XG4gICAgICByZXR1cm4gZmllbGQuc3BsaXQoJy4nKTtcbiAgICB9KVxuICAgIC5maWx0ZXIoZnVuY3Rpb24gKHByb3BzKSB7XG4gICAgICByZXR1cm4gcHJvcHNbMF0gPT09IHJlZmVyS2V5O1xuICAgIH0pXG4gICAgLm1hcChmdW5jdGlvbiAocHJvcHMpIHtcbiAgICAgIHJldHVybiBwcm9wcy5zbGljZSgxKS5qb2luKCcuJyk7XG4gICAgfSlcbiAgICAuY29tcGFjdCgpXG4gICAgLnZhbHVlKCk7XG5cbn07XG5cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgc2VyaWFsaXplOiBmdW5jdGlvbiBzZXJpYWxpemUocmVzb3VyY2UsIG9wdGlvbnMpIHtcblxuICAgIGlmICghcmVzb3VyY2UgaW5zdGFuY2VvZiBSZXNvdXJjZSB8fFxuICAgICAgICAhcmVzb3VyY2UgaW5zdGFuY2VvZiBSZXNvdXJjZUNvbGxlY3Rpb24pIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ3Vuc3VwcG9ydGVkIHR5cGUhJyk7XG4gICAgfVxuXG4gICAgdmFyIHJlc3VsdCA9IHtcbiAgICAgIGRhdGE6IG51bGxcbiAgICB9O1xuXG4gICAgaWYgKHJlc291cmNlIGluc3RhbmNlb2YgUmVzb3VyY2VDb2xsZWN0aW9uKSB7XG5cbiAgICAgIHJlc3VsdCA9IHJlc291cmNlLmNoYWluKClcbiAgICAgICAgLm1hcChmdW5jdGlvbiAocmVzb3VyY2UpIHtcbiAgICAgICAgICByZXR1cm4gc2VyaWFsaXplKHJlc291cmNlLCBvcHRpb25zKTtcbiAgICAgICAgfSlcbiAgICAgICAgLnJlZHVjZShmdW5jdGlvbiAocmVzdWx0LCBzZXJpYWxpemVkUmVzb3VyY2UpIHtcbiAgICAgICAgICByZXN1bHQuZGF0YS5wdXNoKHNlcmlhbGl6ZWRSZXNvdXJjZS5kYXRhKTtcbiAgICAgICAgICByZXN1bHQuaW5jbHVkZWQgPSByZXN1bHQuaW5jbHVkZWQuY29uY2F0KFxuICAgICAgICAgICAgc2VyaWFsaXplZFJlc291cmNlLmluY2x1ZGVkIHx8IFtdKTtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9LCB7XG4gICAgICAgICAgZGF0YTogW10sXG4gICAgICAgICAgaW5jbHVkZWQ6IFtdXG4gICAgICAgIH0pXG4gICAgICAgIC52YWx1ZSgpO1xuXG4gICAgfVxuICAgIGVsc2Uge1xuXG4gICAgICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7XG4gICAgICAgIGluY2x1ZGU6IFtdLFxuICAgICAgICBmaWVsZHM6IHt9XG4gICAgICB9KTtcblxuICAgICAgaWYgKCFvcHRpb25zLmZpZWxkc1tyZXNvdXJjZS50eXBlXSkge1xuICAgICAgICBvcHRpb25zLmZpZWxkc1tyZXNvdXJjZS50eXBlXSA9IF8ua2V5cyhyZXNvdXJjZS5hdHRyaWJ1dGVzKTtcbiAgICAgIH1cblxuICAgICAgcmVzdWx0LmRhdGEgPSBfLnBpY2socmVzb3VyY2UudG9KU09OKCksXG4gICAgICAgIG9wdGlvbnMuZmllbGRzW3Jlc291cmNlLnR5cGVdLCAndHlwZScsICdpZCcpO1xuXG4gICAgICByZXN1bHQuZGF0YS5saW5rcyA9IF8ubWFwVmFsdWVzKHJlc291cmNlLmdldExpbmtzKCksIGZ1bmN0aW9uIChyZXNvdXJjZSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGxpbmthZ2U6IHJlc291cmNlLnRvTGlua2FnZSgpXG4gICAgICAgIH07XG4gICAgICB9KTtcblxuICAgICAgcmVzdWx0LmluY2x1ZGVkID0gXy5jaGFpbihyZXNvdXJjZS5nZXRMaW5rcygpKVxuICAgICAgICAub21pdChmdW5jdGlvbiAocmVzb3VyY2UsIGtleSkge1xuICAgICAgICAgIHJldHVybiAhXy5jb250YWlucyhvcHRpb25zLmluY2x1ZGUsIGtleSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5tYXAoZnVuY3Rpb24gKHJlc291cmNlLCByZWZlcktleSkge1xuICAgICAgICAgIHJldHVybiBzZXJpYWxpemUocmVzb3VyY2UsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7XG4gICAgICAgICAgICBpbmNsdWRlOiBmaWx0ZXJSZWR1Y2VGaWVsZHMob3B0aW9ucy5pbmNsdWRlLCByZWZlcktleSlcbiAgICAgICAgICB9KSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5yZWR1Y2UoZnVuY3Rpb24gKGluY2x1ZGVkLCBzZXJpYWxpemVkUmVzb3VyY2UpIHtcbiAgICAgICAgICByZXR1cm4gaW5jbHVkZWQuY29uY2F0KFxuICAgICAgICAgICAgaW5jbHVkZWQsXG4gICAgICAgICAgICBzZXJpYWxpemVkUmVzb3VyY2UuZGF0YSxcbiAgICAgICAgICAgIHNlcmlhbGl6ZWRSZXNvdXJjZS5pbmNsdWRlZCk7XG4gICAgICAgIH0sIFtdKVxuICAgICAgICAudmFsdWUoKTtcblxuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG5cbiAgfSxcblxuICBkZXNlcmlhbGl6ZTogZnVuY3Rpb24gKEpTT05SZXNwb25zZSkge1xuXG4gICAgaWYgKCEoSlNPTlJlc3BvbnNlICYmIEpTT05SZXNwb25zZS5kYXRhKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgdmFyIGluY2x1ZGVkID0gXy5yZWR1Y2UoSlNPTlJlc3BvbnNlLmluY2x1ZGVkLCBmdW5jdGlvbiAobWVtbywgb2JqKSB7XG4gICAgICBpZiAoIW1lbW9bb2JqLnR5cGVdKSB7XG4gICAgICAgIG1lbW9bb2JqLnR5cGVdID0ge307XG4gICAgICB9XG4gICAgICBtZW1vW29iai50eXBlXVtvYmouaWRdID0gb2JqO1xuICAgICAgcmV0dXJuIG1lbW87XG4gICAgfSwge30pO1xuXG4gICAgdmFyIGNvbGxlY3RSZXNvdXJjZSA9IGZ1bmN0aW9uIChKU09OUmVzcG9uc2UpIHtcblxuICAgICAgaWYgKF8uaXNBcnJheShKU09OUmVzcG9uc2UpKSB7XG4gICAgICAgIHJldHVybiBuZXcgUmVzb3VyY2VDb2xsZWN0aW9uKFxuICAgICAgICAgIF8ubWFwKEpTT05SZXNwb25zZSwgZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgIHJldHVybiBjb2xsZWN0UmVzb3VyY2UoZGF0YSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdmFyIHJlc3VsdCA9IG5ldyBSZXNvdXJjZShcbiAgICAgICAgXy5vbWl0KEpTT05SZXNwb25zZSwgJ2xpbmtzJylcbiAgICAgICk7XG5cbiAgICAgIGlmIChKU09OUmVzcG9uc2UubGlua3MpIHtcbiAgICAgICAgXy5jaGFpbihKU09OUmVzcG9uc2UubGlua3MpXG4gICAgICAgICAgLm9taXQoZnVuY3Rpb24gKGxpbmspIHtcbiAgICAgICAgICAgIHJldHVybiAhbGluay5saW5rYWdlO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLm1hcFZhbHVlcyhmdW5jdGlvbiAobGluaykge1xuXG4gICAgICAgICAgICBpZiAoXy5pc0FycmF5KGxpbmsubGlua2FnZSkpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RSZXNvdXJjZShcbiAgICAgICAgICAgICAgICBfLm1hcChsaW5rLmxpbmthZ2UsIGZ1bmN0aW9uIChsaW5rYWdlKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gaW5jbHVkZWRbbGlua2FnZS50eXBlXVtsaW5rYWdlLmlkXTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RSZXNvdXJjZShcbiAgICAgICAgICAgICAgICBpbmNsdWRlZFtsaW5rLmxpbmthZ2UudHlwZV1bbGluay5saW5rYWdlLmlkXVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgfSlcbiAgICAgICAgICAuZWFjaChmdW5jdGlvbiAocmVzb3VyY2UsIHJlc291cmNlS2V5KSB7XG4gICAgICAgICAgICByZXN1bHQuYWRkTGluayhyZXNvdXJjZUtleSwgcmVzb3VyY2UpO1xuICAgICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfTtcblxuICAgIHJldHVybiBjb2xsZWN0UmVzb3VyY2UoSlNPTlJlc3BvbnNlLmRhdGEpO1xuXG4gIH1cblxufTtcbiJdfQ==