

'use strict';

var _ = require('lodash');
var Resource = require('./Resource');
var ResourceCollection = require('./ResourceCollection');

var filterReduceFields = function filterReduceFields(fields, referKey) {

  return _.chain(fields).map(function (field) {
    return field.split('.');
  }).filter(function (props) {
    return props[0] === referKey;
  }).map(function (props) {
    return props.slice(1).join('.');
  }).compact().value();
};

module.exports = {

  serialize: function serialize(resource, options) {

    if (!resource instanceof Resource || !resource instanceof ResourceCollection) {
      throw new TypeError('unsupported type!');
    }

    var result = {
      data: null
    };

    if (resource instanceof ResourceCollection) {

      result = resource.chain().map(function (resource) {
        return serialize(resource, options);
      }).reduce(function (result, serializedResource) {
        result.data.push(serializedResource.data);
        result.included = result.included.concat(serializedResource.included || []);
        return result;
      }, {
        data: [],
        included: []
      }).value();
    } else {

      options = _.defaults(options || {}, {
        include: [],
        fields: {}
      });

      if (!options.fields[resource.type]) {
        options.fields[resource.type] = _.keys(resource.attributes);
      }

      result.data = _.pick(resource.toJSON(), options.fields[resource.type], 'type', 'id');

      result.data.links = _.mapValues(resource.getLinks(), function (resource) {
        return {
          linkage: resource.toLinkage()
        };
      });

      result.included = _.chain(resource.getLinks()).omit(function (resource, key) {
        return !_.contains(options.include, key);
      }).map(function (resource, referKey) {
        return serialize(resource, _.extend({}, options, {
          include: filterReduceFields(options.include, referKey)
        }));
      }).reduce(function (included, serializedResource) {
        return included.concat(included, serializedResource.data, serializedResource.included);
      }, []).value();
    }

    return result;
  },

  deserialize: function deserialize(JSONResponse) {

    if (!(JSONResponse && JSONResponse.data)) {
      return null;
    }

    var included = _.reduce(JSONResponse.included, function (memo, obj) {
      if (!memo[obj.type]) {
        memo[obj.type] = {};
      }
      memo[obj.type][obj.id] = obj;
      return memo;
    }, {});

    var collectResource = (function (_collectResource) {
      function collectResource(_x) {
        return _collectResource.apply(this, arguments);
      }

      collectResource.toString = function () {
        return _collectResource.toString();
      };

      return collectResource;
    })(function (JSONResponse) {

      if (_.isArray(JSONResponse)) {
        return new ResourceCollection(_.map(JSONResponse, function (data) {
          return collectResource(data);
        }));
      }

      var result = new Resource(_.omit(JSONResponse, 'links'));

      if (JSONResponse.links) {
        _.chain(JSONResponse.links).omit(function (link) {
          return !link.linkage;
        }).mapValues(function (link) {

          if (_.isArray(link.linkage)) {
            return collectResource(_.map(link.linkage, function (linkage) {
              return included[linkage.type][linkage.id];
            }));
          } else {
            return collectResource(included[link.linkage.type][link.linkage.id]);
          }
        }).each(function (resource, resourceKey) {
          result.addLink(resourceKey, resource);
        });
      }

      return result;
    });

    return collectResource(JSONResponse.data);
  }

};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9qc29uYXBpL3NlcmlhbGl6ZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxZQUFZLENBQUM7O0FBRWIsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzFCLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUNyQyxJQUFJLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDOztBQUd6RCxJQUFJLGtCQUFrQixHQUFHLDRCQUFVLE1BQU0sRUFBRSxRQUFRLEVBQUU7O0FBRW5ELFNBQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FDbkIsR0FBRyxDQUFDLFVBQVUsS0FBSyxFQUFFO0FBQ3BCLFdBQU8sS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztHQUN6QixDQUFDLENBQ0QsTUFBTSxDQUFDLFVBQVUsS0FBSyxFQUFFO0FBQ3ZCLFdBQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsQ0FBQztHQUM5QixDQUFDLENBQ0QsR0FBRyxDQUFDLFVBQVUsS0FBSyxFQUFFO0FBQ3BCLFdBQU8sS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7R0FDakMsQ0FBQyxDQUNELE9BQU8sRUFBRSxDQUNULEtBQUssRUFBRSxDQUFDO0NBRVosQ0FBQzs7QUFHRixNQUFNLENBQUMsT0FBTyxHQUFHOztBQUVmLFdBQVMsRUFBRSxTQUFTLFNBQVMsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFOztBQUUvQyxRQUFJLENBQUMsUUFBUSxZQUFZLFFBQVEsSUFDN0IsQ0FBQyxRQUFRLFlBQVksa0JBQWtCLEVBQUU7QUFDM0MsWUFBTSxJQUFJLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0tBQzFDOztBQUVELFFBQUksTUFBTSxHQUFHO0FBQ1gsVUFBSSxFQUFFLElBQUk7S0FD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SSxDQUFDLE9BQU8sRUFBRSxVQUFVLE9BQU8sRUFBRTtBQUNyQyxxQkFBTyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUMzQyxDQUFDLENBQ0gsQ0FBQztXQUNILE1BQU07QUFDTCxtQkFBTyxlQUFlLENBQ3BCLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQzdDLENBQUM7V0FDSDtTQUVGLENBQUMsQ0FDRCxJQUFJLENBQUMsVUFBVSxRQUFRLEVBQUUsV0FBVyxFQUFFO0FBQ3JDLGdCQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUN2QyxDQUFDLENBQUM7T0FDTjs7QUFFRCxhQUFPLE1BQU0sQ0FBQztLQUVmLENBQUEsQ0FBQzs7QUFFRixXQUFPLGVBQWUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7R0FFM0M7O0NBRUYsQ0FBQyIsImZpbGUiOiJzcmMvanNvbmFwaS9zZXJpYWxpemVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5cbid1c2Ugc3RyaWN0JztcblxudmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciBSZXNvdXJjZSA9IHJlcXVpcmUoJy4vUmVzb3VyY2UnKTtcbnZhciBSZXNvdXJjZUNvbGxlY3Rpb24gPSByZXF1aXJlKCcuL1Jlc291cmNlQ29sbGVjdGlvbicpO1xuXG5cbnZhciBmaWx0ZXJSZWR1Y2VGaWVsZHMgPSBmdW5jdGlvbiAoZmllbGRzLCByZWZlcktleSkge1xuXG4gIHJldHVybiBfLmNoYWluKGZpZWxkcylcbiAgICAubWFwKGZ1bmN0aW9uIChmaWVsZCkge1xuICAgICAgcmV0dXJuIGZpZWxkLnNwbGl0KCcuJyk7XG4gICAgfSlcbiAgICAuZmlsdGVyKGZ1bmN0aW9uIChwcm9wcykge1xuICAgICAgcmV0dXJuIHByb3BzWzBdID09PSByZWZlcktleTtcbiAgICB9KVxuICAgIC5tYXAoZnVuY3Rpb24gKHByb3BzKSB7XG4gICAgICByZXR1cm4gcHJvcHMuc2xpY2UoMSkuam9pbignLicpO1xuICAgIH0pXG4gICAgLmNvbXBhY3QoKVxuICAgIC52YWx1ZSgpO1xuXG59O1xuXG5cbm1vZHVsZS5leHBvcnRzID0ge1xuXG4gIHNlcmlhbGl6ZTogZnVuY3Rpb24gc2VyaWFsaXplKHJlc291cmNlLCBvcHRpb25zKSB7XG5cbiAgICBpZiAoIXJlc291cmNlIGluc3RhbmNlb2YgUmVzb3VyY2UgfHxcbiAgICAgICAgIXJlc291cmNlIGluc3RhbmNlb2YgUmVzb3VyY2VDb2xsZWN0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCd1bnN1cHBvcnRlZCB0eXBlIScpO1xuICAgIH1cblxuICAgIHZhciByZXN1bHQgPSB7XG4gICAgICBkYXRhOiBudWxsXG4gICAgfTtcblxuICAgIGlmIChyZXNvdXJjZSBpbnN0YW5jZW9mIFJlc291cmNlQ29sbGVjdGlvbikge1xuXG4gICAgICByZXN1bHQgPSByZXNvdXJjZS5jaGFpbigpXG4gICAgICAgIC5tYXAoZnVuY3Rpb24gKHJlc291cmNlKSB7XG4gICAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZShyZXNvdXJjZSwgb3B0aW9ucyk7XG4gICAgICAgIH0pXG4gICAgICAgIC5yZWR1Y2UoZnVuY3Rpb24gKHJlc3VsdCwgc2VyaWFsaXplZFJlc291cmNlKSB7XG4gICAgICAgICAgcmVzdWx0LmRhdGEucHVzaChzZXJpYWxpemVkUmVzb3VyY2UuZGF0YSk7XG4gICAgICAgICAgcmVzdWx0LmluY2x1ZGVkID0gcmVzdWx0LmluY2x1ZGVkLmNvbmNhdChcbiAgICAgICAgICAgIHNlcmlhbGl6ZWRSZXNvdXJjZS5pbmNsdWRlZCB8fCBbXSk7XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSwge1xuICAgICAgICAgIGRhdGE6IFtdLFxuICAgICAgICAgIGluY2x1ZGVkOiBbXVxuICAgICAgICB9KVxuICAgICAgICAudmFsdWUoKTtcblxuICAgIH1cbiAgICBlbHNlIHtcblxuICAgICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMob3B0aW9ucyB8fCB7fSwge1xuICAgICAgICBpbmNsdWRlOiBbXSxcbiAgICAgICAgZmllbGRzOiB7fVxuICAgICAgfSk7XG5cbiAgICAgIGlmICghb3B0aW9ucy5maWVsZHNbcmVzb3VyY2UudHlwZV0pIHtcbiAgICAgICAgb3B0aW9ucy5maWVsZHNbcmVzb3VyY2UudHlwZV0gPSBfLmtleXMocmVzb3VyY2UuYXR0cmlidXRlcyk7XG4gICAgICB9XG5cbiAgICAgIHJlc3VsdC5kYXRhID0gXy5waWNrKHJlc291cmNlLnRvSlNPTigpLFxuICAgICAgICBvcHRpb25zLmZpZWxkc1tyZXNvdXJjZS50eXBlXSwgJ3R5cGUnLCAnaWQnKTtcblxuICAgICAgcmVzdWx0LmRhdGEubGlua3MgPSBfLm1hcFZhbHVlcyhyZXNvdXJjZS5nZXRMaW5rcygpLCBmdW5jdGlvbiAocmVzb3VyY2UpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBsaW5rYWdlOiByZXNvdXJjZS50b0xpbmthZ2UoKVxuICAgICAgICB9O1xuICAgICAgfSk7XG5cbiAgICAgIHJlc3VsdC5pbmNsdWRlZCA9IF8uY2hhaW4ocmVzb3VyY2UuZ2V0TGlua3MoKSlcbiAgICAgICAgLm9taXQoZnVuY3Rpb24gKHJlc291cmNlLCBrZXkpIHtcbiAgICAgICAgICByZXR1cm4gIV8uY29udGFpbnMob3B0aW9ucy5pbmNsdWRlLCBrZXkpO1xuICAgICAgICB9KVxuICAgICAgICAubWFwKGZ1bmN0aW9uIChyZXNvdXJjZSwgcmVmZXJLZXkpIHtcbiAgICAgICAgICByZXR1cm4gc2VyaWFsaXplKHJlc291cmNlLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge1xuICAgICAgICAgICAgaW5jbHVkZTogZmlsdGVyUmVkdWNlRmllbGRzKG9wdGlvbnMuaW5jbHVkZSwgcmVmZXJLZXkpXG4gICAgICAgICAgfSkpO1xuICAgICAgICB9KVxuICAgICAgICAucmVkdWNlKGZ1bmN0aW9uIChpbmNsdWRlZCwgc2VyaWFsaXplZFJlc291cmNlKSB7XG4gICAgICAgICAgcmV0dXJuIGluY2x1ZGVkLmNvbmNhdChcbiAgICAgICAgICAgIGluY2x1ZGVkLFxuICAgICAgICAgICAgc2VyaWFsaXplZFJlc291cmNlLmRhdGEsXG4gICAgICAgICAgICBzZXJpYWxpemVkUmVzb3VyY2UuaW5jbHVkZWQpO1xuICAgICAgICB9LCBbXSlcbiAgICAgICAgLnZhbHVlKCk7XG5cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuXG4gIH0sXG5cbiAgZGVzZXJpYWxpemU6IGZ1bmN0aW9uIChKU09OUmVzcG9uc2UpIHtcblxuICAgIGlmICghKEpTT05SZXNwb25zZSAmJiBKU09OUmVzcG9uc2UuZGF0YSkpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHZhciBpbmNsdWRlZCA9IF8ucmVkdWNlKEpTT05SZXNwb25zZS5pbmNsdWRlZCwgZnVuY3Rpb24gKG1lbW8sIG9iaikge1xuICAgICAgaWYgKCFtZW1vW29iai50eXBlXSkge1xuICAgICAgICBtZW1vW29iai50eXBlXSA9IHt9O1xuICAgICAgfVxuICAgICAgbWVtb1tvYmoudHlwZV1bb2JqLmlkXSA9IG9iajtcbiAgICAgIHJldHVybiBtZW1vO1xuICAgIH0sIHt9KTtcblxuICAgIHZhciBjb2xsZWN0UmVzb3VyY2UgPSBmdW5jdGlvbiAoSlNPTlJlc3BvbnNlKSB7XG5cbiAgICAgIGlmIChfLmlzQXJyYXkoSlNPTlJlc3BvbnNlKSkge1xuICAgICAgICByZXR1cm4gbmV3IFJlc291cmNlQ29sbGVjdGlvbihcbiAgICAgICAgICBfLm1hcChKU09OUmVzcG9uc2UsIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICByZXR1cm4gY29sbGVjdFJlc291cmNlKGRhdGEpO1xuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHZhciByZXN1bHQgPSBuZXcgUmVzb3VyY2UoXG4gICAgICAgIF8ub21pdChKU09OUmVzcG9uc2UsICdsaW5rcycpXG4gICAgICApO1xuXG4gICAgICBpZiAoSlNPTlJlc3BvbnNlLmxpbmtzKSB7XG4gICAgICAgIF8uY2hhaW4oSlNPTlJlc3BvbnNlLmxpbmtzKVxuICAgICAgICAgIC5vbWl0KGZ1bmN0aW9uIChsaW5rKSB7XG4gICAgICAgICAgICByZXR1cm4gIWxpbmsubGlua2FnZTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5tYXBWYWx1ZXMoZnVuY3Rpb24gKGxpbmspIHtcblxuICAgICAgICAgICAgaWYgKF8uaXNBcnJheShsaW5rLmxpbmthZ2UpKSB7XG4gICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0UmVzb3VyY2UoXG4gICAgICAgICAgICAgICAgXy5tYXAobGluay5saW5rYWdlLCBmdW5jdGlvbiAobGlua2FnZSkge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGluY2x1ZGVkW2xpbmthZ2UudHlwZV1bbGlua2FnZS5pZF07XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0UmVzb3VyY2UoXG4gICAgICAgICAgICAgICAgaW5jbHVkZWRbbGluay5saW5rYWdlLnR5cGVdW2xpbmsubGlua2FnZS5pZF1cbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgIH0pXG4gICAgICAgICAgLmVhY2goZnVuY3Rpb24gKHJlc291cmNlLCByZXNvdXJjZUtleSkge1xuICAgICAgICAgICAgcmVzdWx0LmFkZExpbmsocmVzb3VyY2VLZXksIHJlc291cmNlKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlc3VsdDtcblxuICAgIH07XG5cbiAgICByZXR1cm4gY29sbGVjdFJlc291cmNlKEpTT05SZXNwb25zZS5kYXRhKTtcblxuICB9XG5cbn07XG4iXX0=