
'use strict';

var _ = require('lodash');
var Q = require('q');
var Backbone = require('backbone');
var Events = Backbone.Events;
var ResourceCollection = require('./ResourceCollection');
var serializer = require('./serializer');
var JSONCamera = require('./lib/JSONCamera');
var diffJSON = require('./lib/diffJSON');

var ResourceSession = function ResourceSession(resources, url, options) {

  if (!resources || !url) {
    throw new Error('unenough arguments');
  }

  if (!resources instanceof ResourceCollection) {
    throw new TypeError();
  }

  options = _.defaults(options || {}, {
    syncronizer: {
      post: function post() {},
      patch: function patch() {},
      'delete': function _delete() {},
      get: function get() {}
    } });

  this.url = url;
  this.cameras = {};
  this.added = [];
  this.removed = [];
  this.changed = [];
  this.resources = resources;
  this.syncronizer = options.syncronizer;

  this.resources.each(function (resource) {

    if (resource.id) {
      this._createCamera(resource).capture();
    } else {
      this.added.push(resource);
    }
  }, this);

  this.listenTo(this.resources, 'add', this._trackAdded);
  this.listenTo(this.resources, 'remove', this._trackRemoved);
  this.listenTo(this.resources, 'change', this._trackChanged);
};

_.extend(ResourceSession.prototype, Events, {

  fetch: function fetch(id) {

    if (!id) {
      throw new Error('id required');
    }

    if (_.isNumber(id)) {
      return this._fetchResourceByID(id);
    } else if (_.isArray(id)) {
      return this._fetchResourcesByIDs(id);
    } else {
      throw new Error('invalid type');
    }
  },

  _fetchResourceByID: function _fetchResourceByID(id) {

    return this.syncronizer.get(this.url + id + '/').then((function (res) {
      var resource = res.resource;
      this.resources.add(resource, { merge: true });
      return resource;
    }).bind(this));
  },

  _fetchResourcesByIDs: function _fetchResourcesByIDs(ids) {

    return this.syncronizer.get(this.url, {
      filter: {
        id: ids
      }
    }).then((function (res) {
      var resource = res.resource;
      this.resources.add(resource.models, { merge: true });
      return resource;
    }).bind(this));
  },

  commit: function commit() {

    this._syncResources();
    this._resetCameras();
    this._resetTrackers();
  },

  _syncResources: function _syncResources() {

    this._patchChangedResources();
    this._postAddedResources();
    this._deleteRemovedResources();
  },

  _patchChangedResources: function _patchChangedResources() {

    var patchData = _.chain(this.changed).filter((function (resource) {
      var camera = this._getCamera(resource);
      return !_.isEqual(camera.first(), camera.last());
    }).bind(this)).map(function (resource) {
      return serializer.serialize(resource, { include: [] }).data;
    }).value();

    if (!_.isEmpty(patchData)) {
      this.syncronizer.patch(this.url, {
        data: patchData
      });
    }
  },

  _postAddedResources: function _postAddedResources() {

    var postData = _.map(this.added, function (resource) {
      return serializer.serialize(resource, { include: [] }).data;
    });

    if (!_.isEmpty(postData)) {
      this.syncronizer.post(this.url, {
        data: postData
      });
    }
  },

  _deleteRemovedResources: function _deleteRemovedResources() {

    var deleteData = _.map(this.removed, function (resource) {
      return resource.toLinkage();
    });

    if (!_.isEmpty(deleteData)) {
      this.syncronizer['delete'](this.url, {
        data: deleteData
      });
    }
  },

  _resetCameras: function _resetCameras() {

    _.each(this.changed, function (resource) {
      var camera = this._getCamera(resource);
      camera.snapshots = camera.snapshots.slice(-1);
    }, this);

    _.each(this.added, function (resource) {
      this._createCamera(resource).capture();
    }, this);

    _.each(this.removed, function (resource) {
      this._removeCamera(resource);
    }, this);
  },

  _resetTrackers: function _resetTrackers() {

    this.addad = [];
    this.removed = [];
    this.changed = [];
  },

  _trackAdded: function _trackAdded(resource) {

    if (_.contains(this.removed, resource)) {
      _.pull(this.removed, this.resources);
      return;
    }
    this.added.push(resource);
  },

  _trackRemoved: function _trackRemoved(resource) {

    if (_.contains(this.added, resource)) {
      _.pull(this.added, this.resources);
      return;
    }
    this.removed.push(resource);
  },

  _trackChanged: function _trackChanged(resource) {

    this.changed.push(resource);
    this._getCamera(resource).capture();
  },

  _createCamera: function _createCamera(resource) {

    var camera = new JSONCamera(resource, function (resource) {
      var JSONResponse = serializer.serialize(resource, { include: [] });
      return JSONResponse.data;
    });

    this.cameras[resource.cid] = camera;

    return camera;
  },

  _removeCamera: function _removeCamera(resource) {

    delete this.cameras[resource.cid];
  },

  _getCamera: function _getCamera(resource) {

    return this.cameras[resource.cid];
  }

});

module.exports = ResourceSession;
//# sourceMappingURL=data:application/json;base64,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QU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7R0FFN0I7O0FBRUQsZUFBYSxFQUFFLHVCQUFVLFFBQVEsRUFBRTs7QUFFakMsUUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDNUIsUUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztHQUVyQzs7QUFFRCxlQUFhLEVBQUUsdUJBQVUsUUFBUSxFQUFFOztBQUVqQyxRQUFJLE1BQU0sR0FBRyxJQUFJLFVBQVUsQ0FBQyxRQUFRLEVBQUUsVUFBVSxRQUFRLEVBQUU7QUFDeEQsVUFBSSxZQUFZLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNuRSxhQUFPLFlBQVksQ0FBQyxJQUFJLENBQUM7S0FDMUIsQ0FBQyxDQUFDOztBQUVILFFBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQzs7QUFFcEMsV0FBTyxNQUFNLENBQUM7R0FFZjs7QUFFRCxlQUFhLEVBQUUsdUJBQVUsUUFBUSxFQUFFOztBQUVqQyxXQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0dBRW5DOztBQUVELFlBQVUsRUFBRSxvQkFBVSxRQUFRLEVBQUU7O0FBRTlCLFdBQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7R0FFbkM7O0NBRUYsQ0FBQyxDQUFDOztBQUVILE1BQU0sQ0FBQyxPQUFPLEdBQUcsZUFBZSxDQUFDIiwiZmlsZSI6InNyYy9TZXNzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG4ndXNlIHN0cmljdCc7XG5cblxudmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciBRID0gcmVxdWlyZSgncScpO1xudmFyIEJhY2tib25lID0gcmVxdWlyZSgnYmFja2JvbmUnKTtcbnZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHM7XG52YXIgUmVzb3VyY2VDb2xsZWN0aW9uID0gcmVxdWlyZSgnLi9SZXNvdXJjZUNvbGxlY3Rpb24nKTtcbnZhciBzZXJpYWxpemVyID0gcmVxdWlyZSgnLi9zZXJpYWxpemVyJyk7XG52YXIgSlNPTkNhbWVyYSA9IHJlcXVpcmUoJy4vbGliL0pTT05DYW1lcmEnKTtcbnZhciBkaWZmSlNPTiA9IHJlcXVpcmUoJy4vbGliL2RpZmZKU09OJyk7XG5cblxudmFyIFJlc291cmNlU2Vzc2lvbiA9IGZ1bmN0aW9uIFJlc291cmNlU2Vzc2lvbiAocmVzb3VyY2VzLCB1cmwsIG9wdGlvbnMpIHtcblxuICBpZiAoIXJlc291cmNlcyB8fCAhdXJsKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCd1bmVub3VnaCBhcmd1bWVudHMnKTtcbiAgfVxuXG4gIGlmICghcmVzb3VyY2VzIGluc3RhbmNlb2YgUmVzb3VyY2VDb2xsZWN0aW9uKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcigpO1xuICB9XG5cbiAgb3B0aW9ucyA9IF8uZGVmYXVsdHMob3B0aW9ucyB8fCB7fSwge1xuICAgIHN5bmNyb25pemVyOiB7XG4gICAgICBwb3N0OiBmdW5jdGlvbiAoKSB7fSxcbiAgICAgIHBhdGNoOiBmdW5jdGlvbiAoKSB7fSxcbiAgICAgIGRlbGV0ZTogZnVuY3Rpb24gKCkge30sXG4gICAgICBnZXQ6IGZ1bmN0aW9uICgpIHt9XG4gICAgfSxcbiAgfSk7XG5cbiAgdGhpcy51cmwgPSB1cmw7XG4gIHRoaXMuY2FtZXJhcyA9IHt9O1xuICB0aGlzLmFkZGVkID0gW107XG4gIHRoaXMucmVtb3ZlZCA9IFtdO1xuICB0aGlzLmNoYW5nZWQgPSBbXTtcbiAgdGhpcy5yZXNvdXJjZXMgPSByZXNvdXJjZXM7XG4gIHRoaXMuc3luY3Jvbml6ZXIgPSBvcHRpb25zLnN5bmNyb25pemVyO1xuXG4gIHRoaXMucmVzb3VyY2VzLmVhY2goZnVuY3Rpb24gKHJlc291cmNlKSB7XG5cbiAgICBpZiAocmVzb3VyY2UuaWQpIHtcbiAgICAgIHRoaXMuX2NyZWF0ZUNhbWVyYShyZXNvdXJjZSkuY2FwdHVyZSgpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHRoaXMuYWRkZWQucHVzaChyZXNvdXJjZSk7XG4gICAgfVxuXG4gIH0sIHRoaXMpO1xuXG4gIHRoaXMubGlzdGVuVG8odGhpcy5yZXNvdXJjZXMsICdhZGQnLCB0aGlzLl90cmFja0FkZGVkKTtcbiAgdGhpcy5saXN0ZW5Ubyh0aGlzLnJlc291cmNlcywgJ3JlbW92ZScsIHRoaXMuX3RyYWNrUmVtb3ZlZCk7XG4gIHRoaXMubGlzdGVuVG8odGhpcy5yZXNvdXJjZXMsICdjaGFuZ2UnLCB0aGlzLl90cmFja0NoYW5nZWQpO1xuXG59O1xuXG5cbl8uZXh0ZW5kKFJlc291cmNlU2Vzc2lvbi5wcm90b3R5cGUsIEV2ZW50cywge1xuXG4gIGZldGNoOiBmdW5jdGlvbiAoaWQpIHtcblxuICAgIGlmICghaWQpIHsgdGhyb3cgbmV3IEVycm9yKCdpZCByZXF1aXJlZCcpOyB9XG5cbiAgICBpZiAoXy5pc051bWJlcihpZCkpIHtcbiAgICAgIHJldHVybiB0aGlzLl9mZXRjaFJlc291cmNlQnlJRChpZCk7XG4gICAgfVxuICAgIGVsc2UgaWYgKF8uaXNBcnJheShpZCkpIHtcbiAgICAgIHJldHVybiB0aGlzLl9mZXRjaFJlc291cmNlc0J5SURzKGlkKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgdHlwZScpO1xuICAgIH1cblxuICB9LFxuXG4gIF9mZXRjaFJlc291cmNlQnlJRDogZnVuY3Rpb24gKGlkKSB7XG5cbiAgICByZXR1cm4gdGhpcy5zeW5jcm9uaXplci5nZXQodGhpcy51cmwgKyBpZCArICcvJylcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXMpIHtcbiAgICAgICAgdmFyIHJlc291cmNlID0gcmVzLnJlc291cmNlO1xuICAgICAgICB0aGlzLnJlc291cmNlcy5hZGQocmVzb3VyY2UsIHsgbWVyZ2U6IHRydWUgfSk7XG4gICAgICAgIHJldHVybiByZXNvdXJjZTtcbiAgICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgfSxcblxuICBfZmV0Y2hSZXNvdXJjZXNCeUlEczogZnVuY3Rpb24gKGlkcykge1xuXG4gICAgcmV0dXJuIHRoaXMuc3luY3Jvbml6ZXIuZ2V0KHRoaXMudXJsLCB7XG4gICAgICAgIGZpbHRlcjoge1xuICAgICAgICAgIGlkOiBpZHNcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXMpIHtcbiAgICAgICAgdmFyIHJlc291cmNlID0gcmVzLnJlc291cmNlO1xuICAgICAgICB0aGlzLnJlc291cmNlcy5hZGQocmVzb3VyY2UubW9kZWxzLCB7IG1lcmdlOiB0cnVlIH0pO1xuICAgICAgICByZXR1cm4gcmVzb3VyY2U7XG4gICAgICB9LmJpbmQodGhpcykpO1xuXG4gIH0sXG5cbiAgY29tbWl0OiBmdW5jdGlvbiAoKSB7XG5cbiAgICB0aGlzLl9zeW5jUmVzb3VyY2VzKCk7XG4gICAgdGhpcy5fcmVzZXRDYW1lcmFzKCk7XG4gICAgdGhpcy5fcmVzZXRUcmFja2VycygpO1xuXG4gIH0sXG5cbiAgX3N5bmNSZXNvdXJjZXM6IGZ1bmN0aW9uICgpIHtcblxuICAgIHRoaXMuX3BhdGNoQ2hhbmdlZFJlc291cmNlcygpO1xuICAgIHRoaXMuX3Bvc3RBZGRlZFJlc291cmNlcygpO1xuICAgIHRoaXMuX2RlbGV0ZVJlbW92ZWRSZXNvdXJjZXMoKTtcblxuICB9LFxuXG4gIF9wYXRjaENoYW5nZWRSZXNvdXJjZXM6IGZ1bmN0aW9uICgpIHtcblxuICAgIHZhciBwYXRjaERhdGEgPSBfLmNoYWluKHRoaXMuY2hhbmdlZClcbiAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKHJlc291cmNlKSB7XG4gICAgICAgIHZhciBjYW1lcmEgPSB0aGlzLl9nZXRDYW1lcmEocmVzb3VyY2UpO1xuICAgICAgICByZXR1cm4gIV8uaXNFcXVhbChjYW1lcmEuZmlyc3QoKSwgY2FtZXJhLmxhc3QoKSk7XG4gICAgICB9LmJpbmQodGhpcykpXG4gICAgICAubWFwKGZ1bmN0aW9uIChyZXNvdXJjZSkge1xuICAgICAgICByZXR1cm4gc2VyaWFsaXplci5zZXJpYWxpemUocmVzb3VyY2UsIHsgaW5jbHVkZTogW10gfSkuZGF0YTtcbiAgICAgIH0pXG4gICAgICAudmFsdWUoKTtcblxuICAgIGlmICghXy5pc0VtcHR5KHBhdGNoRGF0YSkpIHtcbiAgICAgIHRoaXMuc3luY3Jvbml6ZXIucGF0Y2godGhpcy51cmwsIHtcbiAgICAgICAgZGF0YTogcGF0Y2hEYXRhXG4gICAgICB9KTtcbiAgICB9XG5cbiAgfSxcblxuICBfcG9zdEFkZGVkUmVzb3VyY2VzOiBmdW5jdGlvbiAoKSB7XG5cbiAgICB2YXIgcG9zdERhdGEgPSBfLm1hcCh0aGlzLmFkZGVkLCBmdW5jdGlvbiAocmVzb3VyY2UpIHtcbiAgICAgIHJldHVybiBzZXJpYWxpemVyLnNlcmlhbGl6ZShyZXNvdXJjZSwgeyBpbmNsdWRlOiBbXSB9KS5kYXRhO1xuICAgIH0pO1xuXG4gICAgaWYgKCFfLmlzRW1wdHkocG9zdERhdGEpKSB7XG4gICAgICB0aGlzLnN5bmNyb25pemVyLnBvc3QodGhpcy51cmwsIHtcbiAgICAgICAgZGF0YTogcG9zdERhdGFcbiAgICAgIH0pO1xuICAgIH1cblxuICB9LFxuXG4gIF9kZWxldGVSZW1vdmVkUmVzb3VyY2VzOiBmdW5jdGlvbiAoKSB7XG5cbiAgICB2YXIgZGVsZXRlRGF0YSA9IF8ubWFwKHRoaXMucmVtb3ZlZCwgZnVuY3Rpb24gKHJlc291cmNlKSB7XG4gICAgICByZXR1cm4gcmVzb3VyY2UudG9MaW5rYWdlKCk7XG4gICAgfSk7XG5cbiAgICBpZiAoIV8uaXNFbXB0eShkZWxldGVEYXRhKSkge1xuICAgICAgdGhpcy5zeW5jcm9uaXplci5kZWxldGUodGhpcy51cmwsIHtcbiAgICAgICAgZGF0YTogZGVsZXRlRGF0YVxuICAgICAgfSk7XG4gICAgfVxuXG4gIH0sXG5cbiAgX3Jlc2V0Q2FtZXJhczogZnVuY3Rpb24gKCkge1xuXG4gICAgXy5lYWNoKHRoaXMuY2hhbmdlZCwgZnVuY3Rpb24gKHJlc291cmNlKSB7XG4gICAgICB2YXIgY2FtZXJhID0gdGhpcy5fZ2V0Q2FtZXJhKHJlc291cmNlKTtcbiAgICAgIGNhbWVyYS5zbmFwc2hvdHMgPSBjYW1lcmEuc25hcHNob3RzLnNsaWNlKC0xKTtcbiAgICB9LCB0aGlzKTtcblxuICAgIF8uZWFjaCh0aGlzLmFkZGVkLCBmdW5jdGlvbiAocmVzb3VyY2UpIHtcbiAgICAgIHRoaXMuX2NyZWF0ZUNhbWVyYShyZXNvdXJjZSkuY2FwdHVyZSgpO1xuICAgIH0sIHRoaXMpO1xuXG4gICAgXy5lYWNoKHRoaXMucmVtb3ZlZCwgZnVuY3Rpb24gKHJlc291cmNlKSB7XG4gICAgICB0aGlzLl9yZW1vdmVDYW1lcmEocmVzb3VyY2UpO1xuICAgIH0sIHRoaXMpO1xuXG4gIH0sXG5cbiAgX3Jlc2V0VHJhY2tlcnM6IGZ1bmN0aW9uICgpIHtcblxuICAgIHRoaXMuYWRkYWQgPSBbXTtcbiAgICB0aGlzLnJlbW92ZWQgPSBbXTtcbiAgICB0aGlzLmNoYW5nZWQgPSBbXTtcblxuICB9LFxuXG4gIF90cmFja0FkZGVkOiBmdW5jdGlvbiAocmVzb3VyY2UpIHtcblxuICAgIGlmIChfLmNvbnRhaW5zKHRoaXMucmVtb3ZlZCwgcmVzb3VyY2UpKSB7XG4gICAgICBfLnB1bGwodGhpcy5yZW1vdmVkLCB0aGlzLnJlc291cmNlcyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuYWRkZWQucHVzaChyZXNvdXJjZSk7XG5cbiAgfSxcblxuICBfdHJhY2tSZW1vdmVkOiBmdW5jdGlvbiAocmVzb3VyY2UpIHtcblxuICAgIGlmIChfLmNvbnRhaW5zKHRoaXMuYWRkZWQsIHJlc291cmNlKSkge1xuICAgICAgXy5wdWxsKHRoaXMuYWRkZWQsIHRoaXMucmVzb3VyY2VzKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5yZW1vdmVkLnB1c2gocmVzb3VyY2UpO1xuXG4gIH0sXG5cbiAgX3RyYWNrQ2hhbmdlZDogZnVuY3Rpb24gKHJlc291cmNlKSB7XG5cbiAgICB0aGlzLmNoYW5nZWQucHVzaChyZXNvdXJjZSk7XG4gICAgdGhpcy5fZ2V0Q2FtZXJhKHJlc291cmNlKS5jYXB0dXJlKCk7XG5cbiAgfSxcblxuICBfY3JlYXRlQ2FtZXJhOiBmdW5jdGlvbiAocmVzb3VyY2UpIHtcblxuICAgIHZhciBjYW1lcmEgPSBuZXcgSlNPTkNhbWVyYShyZXNvdXJjZSwgZnVuY3Rpb24gKHJlc291cmNlKSB7XG4gICAgICB2YXIgSlNPTlJlc3BvbnNlID0gc2VyaWFsaXplci5zZXJpYWxpemUocmVzb3VyY2UsIHsgaW5jbHVkZTogW10gfSk7XG4gICAgICByZXR1cm4gSlNPTlJlc3BvbnNlLmRhdGE7XG4gICAgfSk7XG5cbiAgICB0aGlzLmNhbWVyYXNbcmVzb3VyY2UuY2lkXSA9IGNhbWVyYTtcblxuICAgIHJldHVybiBjYW1lcmE7XG5cbiAgfSxcblxuICBfcmVtb3ZlQ2FtZXJhOiBmdW5jdGlvbiAocmVzb3VyY2UpIHtcblxuICAgIGRlbGV0ZSB0aGlzLmNhbWVyYXNbcmVzb3VyY2UuY2lkXTtcblxuICB9LFxuXG4gIF9nZXRDYW1lcmE6IGZ1bmN0aW9uIChyZXNvdXJjZSkge1xuXG4gICAgcmV0dXJuIHRoaXMuY2FtZXJhc1tyZXNvdXJjZS5jaWRdO1xuXG4gIH1cblxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gUmVzb3VyY2VTZXNzaW9uO1xuIl19